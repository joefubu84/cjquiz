"use strict";var path=require("path"),http=require("http"),express=require("express"),socketIO=require("socket.io"),_require=require("./utils/liveGames"),LiveGames=_require.LiveGames,_require2=require("./utils/players"),Players=_require2.Players,publicPath=path.join(__dirname,"../public"),app=express(),server=http.createServer(app),io=socketIO(server),games=new LiveGames,players=new Players,MongoClient=require("mongodb").MongoClient,mongoose=require("mongoose"),url="mongodb://localhost:27017/";app.use(express.static(publicPath)),server.listen(3e3,function(){console.log("Server started on port 3000")}),io.on("connection",function(q){q.on("host-join",function(r){MongoClient.connect(url,function(e,n){if(e)throw e;var a=n.db("kahootDB"),o={id:parseInt(r.id)};a.collection("kahootGames").find(o).toArray(function(e,a){if(e)throw e;if(void 0!==a[0]){var o=Math.floor(9e4*Math.random())+1e4;games.addGame(o,q.id,!1,{playersAnswered:0,questionLive:!1,gameid:r.id,question:1});var t=games.getGame(q.id);q.join(t.pin),console.log("Game Created with pin:",t.pin),q.emit("showGamePin",{pin:t.pin})}else q.emit("noGameFound");n.close()})})}),q.on("host-join-game",function(e){var a=e.id,o=games.getGame(a);if(o){o.hostId=q.id,q.join(o.pin);for(var c=players.getPlayers(a),t=0;t<Object.keys(players.players).length;t++)players.players[t].hostId==a&&(players.players[t].hostId=q.id);var n=o.gameData.gameid;MongoClient.connect(url,function(e,m){if(e)throw e;var a=m.db("kahootDB"),o={id:parseInt(n)};a.collection("kahootGames").find(o).toArray(function(e,a){if(e)throw e;var o=a[0].questions[0].question,t=a[0].questions[0].answers[0],n=a[0].questions[0].answers[1],r=a[0].questions[0].answers[2],s=a[0].questions[0].answers[3],i=a[0].questions[0].correct;q.emit("gameQuestions",{q1:o,a1:t,a2:n,a3:r,a4:s,correct:i,playersInGame:c.length}),m.close()})}),io.to(o.pin).emit("gameStartedPlayer"),o.gameData.questionLive=!0}else q.emit("noGameFound")}),q.on("player-join",function(e){for(var a=!1,o=0;o<games.games.length;o++)if(e.pin==games.games[o].pin){console.log("Player connected to game");var t=games.games[o].hostId;players.addPlayer(t,q.id,e.name,{score:0,answer:0}),q.join(e.pin);var n=players.getPlayers(t);io.to(e.pin).emit("updatePlayerLobby",n),a=!0}0==a&&q.emit("noGameFound")}),q.on("player-join-game",function(e){var a=players.getPlayer(e.id);if(a){var o=games.getGame(a.hostId);q.join(o.pin),a.playerId=q.id;var t=players.getPlayers(o.hostId);q.emit("playerGameData",t)}else q.emit("noGameFound")}),q.on("disconnect",function(){if(t=games.getGame(q.id)){if(0==t.gameLive){games.removeGame(q.id),console.log("Game ended with pin:",t.pin);for(var e=players.getPlayers(t.hostId),a=0;a<e.length;a++)players.removePlayer(e[a].playerId);io.to(t.pin).emit("hostDisconnect"),q.leave(t.pin)}}else{var o=players.getPlayer(q.id);if(o){var t,n=o.hostId,r=(t=games.getGame(n)).pin;if(0==t.gameLive){players.removePlayer(q.id);var s=players.getPlayers(n);io.to(r).emit("updatePlayerLobby",s),q.leave(r)}}}}),q.on("playerAnswer",function(r){var s=players.getPlayer(q.id),e=s.hostId,i=players.getPlayers(e),m=games.getGame(e);if(1==m.gameData.questionLive){s.gameData.answer=r,m.gameData.playersAnswered+=1;var c=m.gameData.question,t=m.gameData.gameid;MongoClient.connect(url,function(e,n){if(e)throw e;var a=n.db("kahootDB"),o={id:parseInt(t)};a.collection("kahootGames").find(o).toArray(function(e,a){if(e)throw e;var o=a[0].questions[c-1].correct;if(r==o&&(s.gameData.score+=100,io.to(m.pin).emit("getTime",q.id),q.emit("answerResult",!0)),m.gameData.playersAnswered==i.length){m.gameData.questionLive=!1;var t=players.getPlayers(m.hostId);io.to(m.pin).emit("questionOver",t,o)}else io.to(m.pin).emit("updatePlayersAnswered",{playersInGame:i.length,playersAnswered:m.gameData.playersAnswered});n.close()})})}}),q.on("getScore",function(){var e=players.getPlayer(q.id);q.emit("newScore",e.gameData.score)}),q.on("time",function(e){var a=e.time/20;a*=100;var o=e.player;players.getPlayer(o).gameData.score+=a}),q.on("timeUp",function(){var n=games.getGame(q.id);n.gameData.questionLive=!1;var r=players.getPlayers(n.hostId),s=n.gameData.question,i=n.gameData.gameid;MongoClient.connect(url,function(e,t){if(e)throw e;var a=t.db("kahootDB"),o={id:parseInt(i)};a.collection("kahootGames").find(o).toArray(function(e,a){if(e)throw e;var o=a[0].questions[s-1].correct;io.to(n.pin).emit("questionOver",r,o),t.close()})})}),q.on("nextQuestion",function(){for(var f=players.getPlayers(q.id),e=0;e<Object.keys(players.players).length;e++)players.players[e].hostId==q.id&&(players.players[e].gameData.answer=0);var v=games.getGame(q.id);v.gameData.playersAnswered=0,v.gameData.questionLive=!0,v.gameData.question+=1;var t=v.gameData.gameid;MongoClient.connect(url,function(e,h){if(e)throw e;var a=h.db("kahootDB"),o={id:parseInt(t)};a.collection("kahootGames").find(o).toArray(function(e,a){if(e)throw e;if(a[0].questions.length>=v.gameData.question){var o=v.gameData.question;o-=1;var t=a[0].questions[o].question,n=a[0].questions[o].answers[0],r=a[0].questions[o].answers[1],s=a[0].questions[o].answers[2],i=a[0].questions[o].answers[3],m=a[0].questions[o].correct;q.emit("gameQuestions",{q1:t,a1:n,a2:r,a3:s,a4:i,correct:m,playersInGame:f.length}),h.close()}else{for(var c=players.getPlayers(v.hostId),l={name:"",score:0},g={name:"",score:0},u={name:"",score:0},p={name:"",score:0},d={name:"",score:0},y=0;y<c.length;y++)console.log(c[y].gameData.score),c[y].gameData.score>d.score&&(c[y].gameData.score>p.score?c[y].gameData.score>u.score?c[y].gameData.score>g.score?c[y].gameData.score>l.score?(d.name=p.name,d.score=p.score,p.name=u.name,p.score=u.score,u.name=g.name,u.score=g.score,g.name=l.name,g.score=l.score,l.name=c[y].name,l.score=c[y].gameData.score):(d.name=p.name,d.score=p.score,p.name=u.name,p.score=u.score,u.name=g.name,u.score=g.score,g.name=c[y].name,g.score=c[y].gameData.score):(d.name=p.name,d.score=p.score,p.name=u.name,p.score=u.score,u.name=c[y].name,u.score=c[y].gameData.score):(d.name=p.name,d.score=p.score,p.name=c[y].name,p.score=c[y].gameData.score):(d.name=c[y].name,d.score=c[y].gameData.score));io.to(v.pin).emit("GameOver",{num1:l.name,num2:g.name,num3:u.name,num4:p.name,num5:d.name})}})}),io.to(v.pin).emit("nextQuestionPlayer")}),q.on("startGame",function(){var e=games.getGame(q.id);e.gameLive=!0,q.emit("gameStarted",e.hostId)}),q.on("requestDbNames",function(){MongoClient.connect(url,function(e,o){if(e)throw e;o.db("kahootDB").collection("kahootGames").find().toArray(function(e,a){if(e)throw e;q.emit("gameNamesData",a),o.close()})})}),q.on("newQuiz",function(s){MongoClient.connect(url,function(e,n){if(e)throw e;var r=n.db("kahootDB");r.collection("kahootGames").find({}).toArray(function(e,a){if(e)throw e;var o=Object.keys(a).length;0==o?o=s.id=1:s.id=a[o-1].id+1;var t=s;r.collection("kahootGames").insertOne(t,function(e,a){if(e)throw e;n.close()}),n.close(),q.emit("startGameFromCreator",o)})})})});